<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì´ìƒ íƒì§€ ê¸°ë²• ì„ íƒ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>

  <style>
    /* ëª¨ë‹¬ ë°°ê²½ */
    #techniqueModal {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    /* ëª¨ë‹¬ ì½˜í…ì¸  */
    #techniqueModal .modal-content {
      background: white; padding: 20px; border-radius: 8px;
      width: 300px; text-align: center;
    }
    #techniqueModal h2 {
      margin-top: 0;
    }
    #techniqueModal button {
      margin-top: 10px; padding: 8px 16px; font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- ì„ íƒ ëª¨ë‹¬ -->
  <div id="techniqueModal">
    <div class="modal-content">
      <h2>ì´ìƒ íƒì§€ ê¸°ë²• ì„ íƒ</h2>
      <label><input type="radio" name="tech" value="cell_frequency" checked> Cell Frequency</label><br>
      <label><input type="radio" name="tech" value="pair_frequency"> Pair Frequency</label><br>
      <label><input type="radio" name="tech" value="trace_similarity"> Trace Similarity</label><br>
      <button onclick="onTechniqueConfirm()">í™•ì¸</button>
    </div>
  </div>

  <!-- ì§€ë„ -->
  <div id="map" style="width:100%; height:600px;"></div>

  <script>
    var map = L.map('map').setView([36.5,127.5],7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    var markers = [], polylines = [], pathCoords = [], updateInterval;

    function clearMap() {
      markers.forEach(m=>map.removeLayer(m));
      polylines.forEach(l=>map.removeLayer(l));
      markers = []; polylines = []; pathCoords = [];
    }

    // CSV â†’ í‘œì‹œ
    function fetchAndRender(csvFile, recenter) {
      fetch(csvFile).then(r=>r.text()).then(data=>{
        const rows = data.trim().split("\n");
        if (recenter && rows.length>1) {
          const [lat,lng] = rows[1].split(",").map(Number);
          map.setView([lat,lng],13);
        }
        clearMap();
        rows.slice(1).forEach(line=>{
          const [lat,lng,anom] = line.split(",");
          const isAnom = anom.trim()==="1";
          const iconUrl = isAnom
            ? 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
            : 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
          const m = L.marker([+lat,+lng], {
            icon:L.icon({iconUrl,iconSize:[32,32]})
          }).addTo(map)
            .bindPopup(isAnom?"ğŸš¨ ì´ìƒ íƒì§€ë¨!":"ìµœê·¼ ìœ„ì¹˜");
          markers.push(m);
          if(isAnom) alert(`ğŸš¨ ì´ìƒì¹˜: (${lat},${lng})`);
          pathCoords.push([+lat,+lng]);
        });
        if (pathCoords.length>1) {
          const line = L.polyline(pathCoords,{color:'blue',weight:3,opacity:0.5}).addTo(map);
          polylines.push(line);
        }
      });
    }

    function startUpdating(tech) {
      // íŒŒì¼ ë§¤í•‘
      const fileMap = {
        cell_frequency:   '/static/test_cell.csv',
        pair_frequency:   'C:/Users/d/OneDrive - ì¶©ë¶ëŒ€í•™êµ/ë°”íƒ• í™”ë©´/ìº¡ìŠ¤í†¤ë””ìì¸/static/test_pair.csv',
        trace_similarity: 'C:/Users/d/OneDrive - ì¶©ë¶ëŒ€í•™êµ/ë°”íƒ• í™”ë©´/ìº¡ìŠ¤í†¤ë””ìì¸/static/test_similarity.csv'
      };
      const csv = fileMap[tech];
      // ì²« ë Œë”ë§ + ë¦¬ì„¼í„°
      fetchAndRender(csv, true);
      // ì£¼ê¸° ë Œë”ë§(ë¦¬ì„¼í„° ì•ˆ í•¨)
      updateInterval = setInterval(()=>fetchAndRender(csv, false), 2000);
    }

    function onTechniqueConfirm() {
      const tech = document.querySelector('input[name=tech]:checked').value;
      document.getElementById('techniqueModal').style.display = 'none';
      // Airflow íŠ¸ë¦¬ê±°
      fetch("http://localhost:8080/api/v1/dags/web_input_dag/dagRuns", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Basic "+btoa("airflow:airflow")
        },
        body:JSON.stringify({conf:{technique:tech}})
      }).then(res=>{
        if(!res.ok) console.error("DAG Trigger ì‹¤íŒ¨:",res.status);
        startUpdating(tech);
      });
    }
  </script>
</body>
</html>